# План реализации системы резервного копирования и экспорта/импорта задач

## Анализ текущей архитектуры

### База данных
- **Файл**: `tasks.db` (SQLite)
- **Таблицы**:
  - `tasks` - основные задачи с полями: id, title, short_description, full_description, status, priority, eisenhower_priority, assigned_to, related_threads, scheduled_date, due_date, tags, created_at, updated_at, completed_at, archived, archived_at, archived_from_status, reminder_time
  - `task_comments` - комментарии к задачам

### Текущие функции работы с задачами
- `get_tasks()` - получение всех задач
- `get_tasks_by_mode()` - получение задач по режиму (kanban/eisenhower)
- `add_task()` - добавление задачи
- `update_task()` - обновление задачи
- `delete_task()` - удаление задачи
- `archive_task()` - архивирование задачи
- `restore_task()` - восстановление задачи
- `get_archived_tasks()` - получение архивированных задач

### Конфигурация
- **Файл**: `config.json`
- Содержит настройки статусов и приоритетов Эйзенхауэра

## План реализации

### 1. Система резервного копирования

#### 1.1 Конфигурация резервного копирования
**Файл**: `config.json` (расширение)
```json
{
  "backup": {
    "enabled": true,
    "interval_hours": 1,
    "primary_paths": [
      "C:\\Backups\\ToDoLite",
      "D:\\Backups\\ToDoLite"
    ],
    "fallback_path": "C:\\Users\\%USERNAME%\\Documents\\ToDoLite_Backups",
    "max_backups": 10,
    "compress": true
  }
}
```

#### 1.2 Модуль резервного копирования
**Файл**: `backup_manager.py`

**Класс**: `BackupManager`
- `__init__(config_path)` - инициализация с загрузкой конфигурации
- `create_backup()` - создание резервной копии
- `restore_backup(backup_file)` - восстановление из резервной копии
- `cleanup_old_backups()` - очистка старых копий
- `get_backup_list()` - получение списка доступных копий
- `validate_backup(backup_file)` - проверка целостности копии

**Методы**:
- `_copy_database(source, destination)` - копирование базы данных
- `_compress_backup(backup_path)` - сжатие резервной копии
- `_check_path_accessibility(path)` - проверка доступности пути
- `_get_backup_filename()` - генерация имени файла копии

#### 1.3 Планировщик резервного копирования
**Файл**: `backup_scheduler.py`

**Класс**: `BackupScheduler`
- `__init__(backup_manager)` - инициализация с менеджером копий
- `start()` - запуск планировщика
- `stop()` - остановка планировщика
- `run_backup_cycle()` - выполнение цикла резервного копирования

**Многопоточность**:
- Использование `threading.Timer` для периодического выполнения
- Отдельный поток для операций копирования
- Блокировка базы данных во время копирования

### 2. Система экспорта задач

#### 2.1 Модуль экспорта
**Файл**: `export_manager.py`

**Класс**: `ExportManager`
- `export_tasks(task_ids, format='json')` - экспорт выбранных задач
- `export_all_tasks(format='json')` - экспорт всех задач
- `export_archived_tasks(format='json')` - экспорт архивированных задач
- `get_export_formats()` - получение доступных форматов

**Поддерживаемые форматы**:
- JSON (основной)
- CSV (для табличных данных)
- XML (для совместимости)

#### 2.2 Веб-интерфейс экспорта
**Файл**: `templates/export.html`

**Функции**:
- Список всех задач с чекбоксами для выбора
- Фильтры по статусу, приоритету, дате
- Выбор формата экспорта
- Предварительный просмотр экспортируемых данных

**API endpoints** (в `app.py`):
- `GET /export` - страница экспорта
- `POST /export/selected` - экспорт выбранных задач
- `GET /export/preview` - предварительный просмотр

### 3. Система импорта задач

#### 3.1 Модуль импорта
**Файл**: `import_manager.py`

**Класс**: `ImportManager`
- `parse_import_file(file_path)` - парсинг файла импорта
- `validate_import_data(data)` - валидация данных импорта
- `import_tasks(task_data, selected_ids)` - импорт выбранных задач
- `get_import_preview(data)` - предварительный просмотр импорта
- `resolve_conflicts(existing_task, imported_task)` - разрешение конфликтов

**Валидация**:
- Проверка обязательных полей
- Проверка форматов дат
- Проверка существующих задач (дубликаты)
- Проверка целостности данных

#### 3.2 Веб-интерфейс импорта
**Файл**: `templates/import.html`

**Функции**:
- Загрузка файла импорта
- Предварительный просмотр импортируемых задач
- Выбор задач для импорта (чекбоксы)
- Настройки импорта (перезапись, пропуск дубликатов)
- Разрешение конфликтов

**API endpoints** (в `app.py`):
- `GET /import` - страница импорта
- `POST /import/upload` - загрузка файла
- `POST /import/preview` - предварительный просмотр
- `POST /import/execute` - выполнение импорта

### 4. Интеграция с основным приложением

#### 4.1 Обновление `app.py`
- Добавление новых маршрутов для экспорта/импорта
- Интеграция с `BackupManager`
- Обработка ошибок и логирование

#### 4.2 Обновление `tray_app.py`
- Запуск `BackupScheduler` при старте приложения
- Остановка планировщика при завершении
- Уведомления о статусе резервного копирования

#### 4.3 Обновление `config.json`
- Добавление секции `backup`
- Добавление настроек экспорта/импорта

### 5. Структура файлов

```
ToDoLite/
├── backup_manager.py          # Менеджер резервного копирования
├── backup_scheduler.py        # Планировщик резервного копирования
├── export_manager.py          # Менеджер экспорта
├── import_manager.py          # Менеджер импорта
├── templates/
│   ├── export.html           # Страница экспорта
│   ├── import.html           # Страница импорта
│   └── backup.html           # Страница управления резервными копиями
├── static/
│   ├── export.js             # JavaScript для экспорта
│   └── import.js             # JavaScript для импорта
└── backups/                  # Папка для резервных копий (создается автоматически)
```

### 6. Многопоточность

#### 6.1 Резервное копирование
- `threading.Timer` для периодического выполнения
- `threading.Lock` для блокировки базы данных
- Отдельный поток для операций копирования

#### 6.2 Экспорт/импорт
- Асинхронная обработка больших файлов
- Прогресс-бары для длительных операций
- Возможность отмены операций

### 7. Безопасность и надежность

#### 7.1 Валидация данных
- Проверка входных данных
- Санитизация файловых путей
- Проверка прав доступа к файлам

#### 7.2 Обработка ошибок
- Логирование всех операций
- Graceful degradation при ошибках
- Восстановление после сбоев

#### 7.3 Резервное копирование
- Атомарные операции копирования
- Проверка целостности копий
- Автоматическая очистка старых копий

### 8. Пользовательский интерфейс

#### 8.1 Навигация
- Добавление пунктов меню "Резервные копии", "Экспорт", "Импорт"
- Интеграция в существующий интерфейс

#### 8.2 Уведомления
- Статус резервного копирования
- Результаты экспорта/импорта
- Ошибки и предупреждения

### 9. Тестирование

#### 9.1 Модульные тесты
- Тестирование всех компонентов
- Тестирование обработки ошибок
- Тестирование многопоточности

#### 9.2 Интеграционные тесты
- Тестирование полного цикла экспорта/импорта
- Тестирование резервного копирования
- Тестирование восстановления

### 10. Документация

#### 10.1 Пользовательская документация
- Руководство по резервному копированию
- Руководство по экспорту/импорту
- FAQ по проблемам

#### 10.2 Техническая документация
- API документация
- Архитектурные решения
- Руководство по развертыванию

## Этапы реализации

### Этап 1: Резервное копирование (1-2 дня)
1. Создание `BackupManager`
2. Создание `BackupScheduler`
3. Интеграция с `tray_app.py`
4. Тестирование

### Этап 2: Экспорт задач (1-2 дня)
1. Создание `ExportManager`
2. Создание веб-интерфейса экспорта
3. Добавление API endpoints
4. Тестирование

### Этап 3: Импорт задач (2-3 дня)
1. Создание `ImportManager`
2. Создание веб-интерфейса импорта
3. Добавление API endpoints
4. Тестирование

### Этап 4: Интеграция и тестирование (1 день)
1. Интеграция всех компонентов
2. Полное тестирование
3. Документация
4. Финальная отладка

## Зависимости

### Новые зависимости
- `APScheduler` - для планировщика резервного копирования
- `python-dateutil` - для работы с датами
- `jsonschema` - для валидации JSON

### Обновление requirements.txt
```
Flask==2.3.3
Werkzeug==2.3.7
pystray==0.19.4
Pillow==10.0.1
plyer==2.1.0
APScheduler==3.10.4
python-dateutil==2.8.2
jsonschema==4.19.2
```

## Риски и митигация

### Риски
1. **Производительность** - резервное копирование может замедлить работу
2. **Безопасность** - неправильная обработка файлов
3. **Совместимость** - проблемы с форматами файлов
4. **Многопоточность** - race conditions

### Митигация
1. Асинхронное выполнение операций
2. Валидация и санитизация данных
3. Поддержка стандартных форматов
4. Использование блокировок и атомарных операций
