# План доработки резервного копирования (v1.5.1)

## Текущее состояние (как работает сейчас)
- Планировщик (`backup_scheduler.py`):
  - Раз в `interval_hours` вызывает `BackupManager.create_backup()`.
  - При успехе — логирует успех; при неудаче — только логирует ошибку «не удалось создать автоматическую резервную копию».
  - Нет уведомлений Windows при полном провале.
- Менеджер (`backup_manager.py`):
  - Берет пути: `primary_paths` + `fallback_path` (один запасной), создаёт резервную копию в ПЕРВОМ успешном пути и возвращает её; при ошибке в пути — пишет в лог и переходит к следующему.
  - Если ни один путь не сработал — пишет ошибку и возвращает `None`.
  - Поддерживает сжатие (`.gz`), чистку старых копий, валидацию бэкапов.
  - Нет уведомления при полном провале; нет одновременного копирования во ВСЕ указанные места.
  - Нет загрузки самой свежей копии на старте приложения.

## Требуемая логика (задача)
1) Каждые 1 час во время работы:
   - Делать резервное копирование базы в ОСНОВНОЕ место и во ВСЕ ДОПОЛНИТЕЛЬНЫЕ места (массив путей).
   - Если в какое‑то место записать нельзя — писать в лог, но продолжать с остальными.
   - Если не удалось сохранить НИКУДА — логировать и показать системное уведомление Windows (Win10/Win11).
2) При запуске программы:
   - Проверить все места (основное + все дополнительные), найти самую свежую копию (по дате/имени файла).
   - Если есть несколько одинаково свежих копий — выбрать по приоритету: основной путь → доп.1 → доп.2 → ...
   - Загрузить (восстановить) эту копию в `tasks.db`.

## План изменений
### 1. Изменение структуры конфигурации (обратная совместимость)
- В `config.json.backup`:
  - Заменить `primary_paths` + `fallback_path` на единый массив `destinations` (в порядке приоритета).
  - Сохранить обратную совместимость: если `destinations` отсутствует — строить список как `primary_paths + [fallback_path]`.

Пример:
```json
"backup": {
  "enabled": true,
  "interval_hours": 1,
  "destinations": [
    "C:\\Backups\\ToDoLite",
    "D:\\Backups\\ToDoLite",
    "C:\\Users\\%USERNAME%\\Documents\\ToDoLite_Backups"
  ],
  "max_backups": 10,
  "compress": true
}
```

### 2. Создание бэкапов сразу во все места
- В `BackupManager.create_backup_all()` (новый метод):
  - Сгенерировать имя копии один раз.
  - Пройти по всем `destinations` и пытаться сохранить копию в каждую директорию (с созданием папок).
  - Для каждой попытки логировать успех/ошибку.
  - Вернуть список успешно созданных путей. Если список пуст — это «полный провал».
- Обновить `BackupScheduler` использовать новый метод:
  - Если успешно создано >=1 копия — лог успех.
  - Если 0 — лог и системное уведомление Windows.

### 3. Уведомления Windows при полном провале
- Добавить утилиту `notify_windows(title, message)` с поддержкой Win10/Win11:
  - Варианты: `winrt` (toast), PowerShell `New-BurntToastNotification` при наличии, либо system tray balloon через pystray (fallback).
  - Минимально: PowerShell toast через `powershell -Command` с встроенным скриптом; fallback — `logger.warning`.

### 4. Восстановление последней копии на старте
- Добавить в `BackupManager` метод `find_latest_backup()`:
  - Собрать список всех копий по всем `destinations`.
  - Определить максимально свежую по timestamp в имени/mtime.
  - Если несколько с одинаковым timestamp — выбрать по порядку приоритета `destinations`.
- Добавить метод `restore_latest_on_start()`:
  - Вызвать `find_latest_backup()`; при наличии — восстановить в `tasks.db` (с валидацией), залогировать результат.
- Включить вызов в старте приложения: из `tray_app.py` до старта сервера (при наличии менеджера и если текущая БД отсутствует/пуста/битая).

### 5. Очистка старых копий
- После успешного сохранения в КАЖДЫЙ путь — запускать `_cleanup_old_backups(path)` как сейчас.

### 6. Логирование
- Для каждого места назначения логировать: попытка → успех/ошибка (с текстом исключения).
- При полном провале — единый лог + уведомление пользователю.

## Точки интеграции
- `backup_manager.py`:
  - Новый: `get_destinations()` (учесть обратную совместимость).
  - Новый: `create_backup_all()`
  - Новый: `find_latest_backup()`
  - Новый: `restore_latest_on_start()`
- `backup_scheduler.py`:
  - Использовать `create_backup_all()`.
  - На 0 успехов — триггерить Windows уведомление.
- `tray_app.py` (или `app.py`):
  - Перед запуском сервера: `BackupManager().restore_latest_on_start()`.
- Уведомления: встроенная утилита `notify_windows()` без дополнительных зависимостей.

## Риски
- Восстановление на старте может перезаписать текущую пустую/поврежденную БД — восстановление выполнять ТОЛЬКО если текущая БД отсутствует/пуста/битая.
- Политики PowerShell могут блокировать toast — оставить мягкий fallback (только логирование).

## Критерии готовности
- Бэкапы создаются одновременно во все места; частичные ошибки не прерывают остальные.
- При полном провале есть лог + Windows уведомление.
- На старте, если база отсутствует/битая — выбирается и поднимается самая свежая копия с учётом приоритета путей.
- Обратная совместимость конфигурации сохранена.

## Статус выполнения (v1.5.1)
- [x] Совместимый список направлений (`get_destinations`), массовый бэкап (`create_backup_all`).
- [x] Планировщик использует массовый бэкап; уведомление Windows при полном провале.
- [x] Автовосстановление последней годной копии на старте (если текущая БД отсутствует/пуста/битая).
- [ ] Документация обновлена (README/техдок по backup.destinations, поведению на старте).
